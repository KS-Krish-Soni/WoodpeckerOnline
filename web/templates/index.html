<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woodpecker Chess Puzzles</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="/static/chess.js"></script>
    <style>
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .header-left {
            flex: 1;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-email {
            color: #2c3e50;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #1a252f;
            color: #1a252f;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-outline:hover {
            background: #1a252f;
            color: white;
        }
        
        .btn-outline:focus {
            outline: 2px solid #f39c12;
            outline-offset: 2px;
        }
        
        .calc-feedback {
            display: none;
        }
        
        .calc-feedback.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .user-menu {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="title">Woodpecker Chess Puzzles</h1>
                    <p class="subtitle">Solve chess puzzles with Go backend logic</p>
                </div>
                <div class="header-right">
                    <div class="user-menu" id="user-menu">
                        <span class="user-email" id="user-email">Loading...</span>
                        <a href="/trainer" class="btn btn-outline">Trainer</a>
                        <a href="/settings" class="btn btn-outline">Settings</a>
                        <button class="btn btn-outline" id="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="main-content">
            <div class="puzzle-layout">
                <!-- Left column: Chess board -->
                <div class="board-section">
                    <div class="puzzle-number" id="puzzleNumber">No puzzle loaded</div>
                    <div class="chess-board-container">
                        <div class="chess-board" id="chessBoard">
                            <!-- Chess board will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Right column: Sidebar -->
                <div class="sidebar">
                    <div class="puzzle-controls">
                        <div class="difficulty-display">
                            <span class="difficulty-label">Difficulty:</span>
                            <span class="difficulty-value" id="difficulty-display">-</span>
                        </div>
                        <button id="btn-next" class="btn btn-primary">Load next puzzle</button>
                        <button id="btn-show-solution" class="btn btn-secondary" disabled>Show solution</button>
                    </div>
                    
                    <div class="puzzle-status">
                        <div class="status-item">
                            <span class="status-label">Status:</span>
                            <span class="status-value" id="status">Ready</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Today:</span>
                            <span class="status-value" id="today-counter">0/0</span>
                        </div>
                        <div class="status-item">
                            <a href="/stats" class="stats-link">ðŸ“Š View Statistics</a>
                        </div>
                    </div>
                    
                    <div class="solution-text-container">
                        <div class="solution-text-header">
                            <span class="solution-label">Solution:</span>
                        </div>
                        <div class="solution-text-content">
                            <span id="solution-text" class="solution-text">Click "Show solution" to display puzzle solution</span>
                        </div>
                    </div>
                    
                    <div class="calculation-pad">
                        <h3>Calculation Pad</h3>
                        <div class="calc-input-group">
                            <input type="text" id="calc-san" class="calc-input" placeholder="Type SAN, e.g., Bxf7+">
                            <button id="btn-add" class="btn btn-small">Add</button>
                        </div>
                        <div class="calc-buttons">
                            <button id="btn-undo" class="btn btn-small btn-secondary">Undo</button>
                            <button id="btn-submit-line" class="btn btn-small btn-primary">Submit line</button>
                            <button id="btn-reset-line" class="btn btn-small btn-secondary">Reset</button>
                        </div>
                        <div class="calc-line-container">
                            <ol id="calc-line" class="calc-line"></ol>
                        </div>
                        <div id="calc-feedback" class="calc-feedback"></div>
                    </div>
                    

                </div>
            </div>
        </main>
        
        <footer class="footer">
            <p>&copy; 2024 Woodpecker Chess Puzzles. Built with HTML, CSS, and Go.</p>
        </footer>
    </div>

    <script src="/static/app.js"></script>
    <script>
        class ChessPuzzle {
            constructor() {
                this.selectedPiece = null;
                this.gameState = null;
                this.playedMoves = [];
                this.currentFEN = '';
                this.currentTurn = 'white';
                
                this.setupEventListeners();
                this.loadGameState();
            }

            async loadGameState() {
                // If chess.js is initialized, use it; otherwise show default chess position
                if (window.app.chess) {
                    const board = window.app.getBoard();
                    
                    this.gameState = {
                        board: board,
                        currentPlayer: window.app.getCurrentTurn() === 'w' ? 'white' : 'black',
                        gameOver: window.app.isGameOver(),
                        moveHistory: window.app.playedMoves,
                        capturedPieces: { white: [], black: [] }
                    };
                    
                    this.renderBoard();
                    this.updateGameInfo();
                } else {
                    // Show default chess position when no puzzle is loaded
                    this.gameState = {
                        board: this.getDefaultBoard(),
                        currentPlayer: 'white',
                        gameOver: false,
                        moveHistory: [],
                        capturedPieces: { white: [], black: [] }
                    };
                    
                    this.renderBoard();
                    this.updateGameInfo();
                }
            }

            renderBoard() {
                if (!this.gameState) {
                    return;
                }
                const boardElement = document.getElementById('chessBoard');
                boardElement.innerHTML = '';
                
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const square = document.createElement('div');
                        // Create alternating pattern with different shades
                        const isLight = (row + col) % 2 === 0;
                        const shadeIndex = Math.floor((row + col) / 2) % 4;
                        square.className = `chess-square ${isLight ? 'light' : 'dark'} shade-${shadeIndex}`;
                        square.dataset.row = row;
                        square.dataset.col = col;
                        
                        // Add coordinate labels
                        let coordinateLabel = '';
                        
                        // Add rank label (1-8) to leftmost squares (col 0)
                        if (col === 0) {
                            const rank = 8 - row;
                            coordinateLabel += `<span class="rank-label">${rank}</span>`;
                        }
                        
                        // Add file label (a-h) to bottom squares (row 7)
                        if (row === 7) {
                            const file = String.fromCharCode(97 + col); // 'a' = 97
                            coordinateLabel += `<span class="file-label">${file}</span>`;
                        }
                        
                        const piece = this.gameState.board[row][col];
                        
                        if (piece) {
                            square.innerHTML = this.getPieceSymbol(piece) + coordinateLabel;
                            square.classList.add('has-piece');
                            square.classList.add(piece.color + '-piece');
                        } else {
                            square.innerHTML = coordinateLabel;
                        }
                        
                        if (this.selectedPiece && this.selectedPiece.row === row && this.selectedPiece.col === col) {
                            square.classList.add('selected');
                        }
                        
                        boardElement.appendChild(square);
                    }
                }
            }

            getDefaultBoard() {
                const board = Array(8).fill(null).map(() => Array(8).fill(null));
                
                // Setup pawns
                for (let i = 0; i < 8; i++) {
                    board[1][i] = { type: 'pawn', color: 'black' };
                    board[6][i] = { type: 'pawn', color: 'white' };
                }
                
                // Setup other pieces
                // Black pieces (top row)
                board[0][0] = { type: 'rook', color: 'black' };
                board[0][1] = { type: 'knight', color: 'black' };
                board[0][2] = { type: 'bishop', color: 'black' };
                board[0][3] = { type: 'queen', color: 'black' };
                board[0][4] = { type: 'king', color: 'black' };
                board[0][5] = { type: 'bishop', color: 'black' };
                board[0][6] = { type: 'knight', color: 'black' };
                board[0][7] = { type: 'rook', color: 'black' };
                
                // White pieces (bottom row)
                board[7][0] = { type: 'rook', color: 'white' };
                board[7][1] = { type: 'knight', color: 'white' };
                board[7][2] = { type: 'bishop', color: 'white' };
                board[7][3] = { type: 'queen', color: 'white' };
                board[7][4] = { type: 'king', color: 'white' };
                board[7][5] = { type: 'bishop', color: 'white' };
                board[7][6] = { type: 'knight', color: 'white' };
                board[7][7] = { type: 'rook', color: 'white' };
                
                return board;
            }
            
            getPieceSymbol(piece) {
                // Check if piece has required properties
                if (!piece || !piece.type || !piece.color) {
                    console.error('Invalid piece object:', piece);
                    return '';
                }
                
                // Map chess.js single-letter piece types to full names
                const pieceTypeMap = {
                    'k': 'king',
                    'q': 'queen',
                    'r': 'rook',
                    'b': 'bishop',
                    'n': 'knight',
                    'p': 'pawn'
                };
                
                // Convert piece type to full name if it's a single letter
                const fullPieceType = pieceTypeMap[piece.type] || piece.type;
                
                const pieceImages = {
                    'king': { white: '/images/white_king.svg', black: '/images/black_king.svg' },
                    'queen': { white: '/images/white_queen.svg', black: '/images/black_queen.svg' },
                    'rook': { white: '/images/white_rook.svg', black: '/images/black_rook.svg' },
                    'bishop': { white: '/images/white_bishop.svg', black: '/images/black_bishop.svg' },
                    'knight': { white: '/images/white_knight.svg', black: '/images/black_knight.svg' },
                    'pawn': { white: '/images/white_pawn.svg', black: '/images/black_pawn.svg' }
                };
                
                // Check if piece type and color are valid
                if (!pieceImages[fullPieceType]) {
                    return '';
                }
                
                if (!pieceImages[fullPieceType][piece.color]) {
                    return '';
                }
                
                const imageSrc = pieceImages[fullPieceType][piece.color];
                return `<img src="${imageSrc}" alt="${piece.color} ${fullPieceType}" class="chess-piece">`;
            }

            setupEventListeners() {
                const boardElement = document.getElementById('chessBoard');
                boardElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('chess-square')) {
                        this.handleSquareClick(e.target);
                    }
                });


            }

            async handleSquareClick(square) {
                if (!this.gameState || this.gameState.gameOver) return;

                const row = parseInt(square.dataset.row);
                const col = parseInt(square.dataset.col);
                const piece = this.gameState.board[row][col];

                // If no piece is selected and clicked square has a piece of current player's color
                if (!this.selectedPiece && piece && piece.color === this.gameState.currentPlayer) {
                    this.selectedPiece = { row, col, piece };
                    this.renderBoard();
                    return;
                }

                // If a piece is selected
                if (this.selectedPiece) {
                    // If clicking on the same piece, deselect it
                    if (this.selectedPiece.row === row && this.selectedPiece.col === col) {
                        this.selectedPiece = null;
                        this.renderBoard();
                        return;
                    }

                    // Try to make a move
                    await this.makeMove(this.selectedPiece.row, this.selectedPiece.col, row, col);
                    this.selectedPiece = null;
                }
            }

            async makeMove(fromRow, fromCol, toRow, toCol) {
                // If chess.js is initialized, use it; otherwise use backend API
                if (window.app.chess) {
                    // Convert board coordinates to chess notation
                    const fromSquare = String.fromCharCode(97 + fromCol) + (8 - fromRow);
                    const toSquare = String.fromCharCode(97 + toCol) + (8 - toRow);
                    
                    // Use chess.js to handle the move
                    const moveSuccess = window.app.handleMove(fromSquare, toSquare);
                    
                    if (moveSuccess) {
                        // Update the game state from chess.js
                        this.gameState = {
                            board: window.app.getBoard(),
                            currentPlayer: window.app.getCurrentTurn() === 'w' ? 'white' : 'black',
                            gameOver: window.app.isGameOver(),
                            moveHistory: window.app.playedSANs, // Use SAN moves instead of coordinate moves
                            capturedPieces: { white: [], black: [] }
                        };
                        
                        this.renderBoard();
                        this.updateGameInfo();
                    }
                } else {
                    // Use backend API for move validation
                    try {
                        const response = await fetch('/api/move', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                fromRow: fromRow,
                                fromCol: fromCol,
                                toRow: toRow,
                                toCol: toCol
                            })
                        });

                        if (response.ok) {
                            this.gameState = await response.json();
                            this.renderBoard();
                            this.updateGameInfo();
                            
                            // Enable submit button when a move is made
                            document.getElementById('btn-submit').disabled = false;
                            
                            // Update puzzle status
                            document.getElementById('status').textContent = 'Move made';
                        }
                    } catch (error) {
                        console.error('Error making move:', error);
                    }
                }
            }

            updateGameInfo() {
                if (!this.gameState) return;
                // Move history functionality removed
            }
        }

        // Authentication functionality
        async function loadUserInfo() {
            try {
                console.log('loadUserInfo: Making request to /api/me');
                console.log('loadUserInfo: Current cookies:', document.cookie);
                const response = await fetch('/api/me', {
                    credentials: 'include'
                });
                console.log('loadUserInfo: Response status:', response.status);
                
                if (response.ok) {
                    const user = await response.json();
                    console.log('loadUserInfo: User data received:', user);
                    document.getElementById('user-email').textContent = user.email;
                    console.log('loadUserInfo: User email set successfully');
                } else {
                    console.error('loadUserInfo: Authentication failed, status:', response.status);
                    const errorText = await response.text();
                    console.error('loadUserInfo: Error response:', errorText);
                    // If not authenticated, redirect to sign-in
                    window.location.href = '/auth/sign-in';
                }
            } catch (error) {
                console.error('loadUserInfo: Error loading user info:', error);
                window.location.href = '/auth/sign-in';
            }
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    window.location.href = '/auth/sign-in';
                } else {
                    console.error('Logout failed');
                }
            } catch (error) {
                console.error('Error during logout:', error);
            }
        }

        // Override uiOK function to show calc-feedback only when needed
        function uiOK(msg) {
            const feedback = document.getElementById('calc-feedback');
            if (feedback) {
                feedback.textContent = msg;
                feedback.className = 'calc-feedback success';
                // Show feedback only if there's a message (not empty)
                if (msg && msg.trim() !== '') {
                    feedback.classList.add('show');
                } else {
                    feedback.classList.remove('show');
                }
            }
        }

        // Initialize the puzzle when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Add a small delay to ensure cookies are properly set
            setTimeout(() => {
                loadUserInfo();
            }, 100);
            window.chessPuzzleInstance = new ChessPuzzle();
            
            // Load puzzle 1 when the page starts
            setTimeout(() => {
                if (typeof loadNextPuzzle === 'function') {
                    loadNextPuzzle();
                }
            }, 200);
            
            // Add logout button event listener
            document.getElementById('logout-btn').addEventListener('click', logout);
        });
    </script>
</body>
</html>
